version: v1.0
name: Continuous Integration Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Build Android App
    run:
      when: 'change_in(''/fortunes-api/'', {default_branch: ''main''})'
    task:
      jobs:
        - name: Build
          commands:
            - 'true'
    dependencies: []
  - name: Test Android App
    run:
      when: 'change_in(''/fortunes-api/'', {default_branch: ''main''})'
    task:
      prologue:
        commands:
          - sem-version go 1.16
          - export GO111MODULE=on
          - export GOPATH=~/go
          - 'export PATH=/home/semaphore/go/bin:$PATH'
          - checkout
          - cd fortunes-api
      jobs:
        - name: Unit tests
          commands:
            - 'true'
          parallelism: 2
    dependencies:
      - Build Android App
  - name: Build iOS App
    run:
      when: 'change_in(''/fortunes-server/'', {default_branch: ''main''})'
    dependencies: []
    task:
      jobs:
        - name: Build
          commands:
            - 'true'
  - name: Test iOS Aapp
    run:
      when: 'change_in(''/fortunes-server/'', {default_branch: ''main''})'
    dependencies:
      - Build iOS App
    task:
      jobs:
        - name: Run Tests
          commands: []
          parallelism: 3
  - name: Publish to Google Play
    dependencies:
      - Test Android App
    task:
      jobs:
        - name: Publish
          commands:
            - 'true'
  - name: Public to App Store
    dependencies:
      - Test iOS Aapp
    task:
      jobs:
        - name: Publish
          commands:
            - 'true'
  - name: Install Web Dependencies
    dependencies: []
    task:
      jobs:
        - name: Bundle install
          commands:
            - 'true'
  - name: Tests
    dependencies:
      - Install Web Dependencies
    task:
      jobs:
        - name: Unit tests
          commands:
            - 'true'
        - name: Integration tests
          commands:
            - 'true'
        - name: Static tests
          commands:
            - 'true'
  - name: Deploy Website
    dependencies:
      - Tests
    task:
      jobs:
        - name: Deploy to prod
          commands:
            - 'true'
