version: v1.0
name: Continuous Integration Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Build Android App
    run:
      when: 'change_in(''/android/'', {default_branch: ''diagram'', pipeline_file: ''ignore''})'
    task:
      jobs:
        - name: Build
          commands:
            - 'true'
    dependencies: []
  - name: Test Android App
    run:
      when: 'change_in(''/android/'', {default_branch: ''diagram'', pipeline_file: ''ignore''})'
    task:
      jobs:
        - name: Unit tests
          commands:
            - 'true'
          parallelism: 2
    dependencies:
      - Build Android App
  - name: Build iOS App
    run:
      when: 'change_in(''/android/'', {default_branch: ''diagram'', pipeline_file: ''ignore''})'
    dependencies: []
    task:
      jobs:
        - name: Build
          commands:
            - 'true'
  - name: Test iOS Aapp
    run:
      when: 'change_in(''/ios/'', {default_branch: ''diagram'', pipeline_file: ''ignore''})'
    dependencies:
      - Build iOS App
    task:
      jobs:
        - name: Run Tests
          commands: []
          parallelism: 3
  - name: Publish to Google Play
    run:
      when: 'change_in(''/android/'', {default_branch: ''diagram'', pipeline_file: ''ignore''})'
    dependencies:
      - Test Android App
    task:
      jobs:
        - name: Publish
          commands:
            - 'true'
  - name: Publish to App Store
    run:
      when: 'change_in(''/android/'', {default_branch: ''diagram'', pipeline_file: ''ignore''})'
    dependencies:
      - Test iOS Aapp
    task:
      jobs:
        - name: Publish
          commands:
            - 'true'
  - name: Install Web Dependencies
    run:
      when: 'change_in(''/web/'', {default_branch: ''diagram'', pipeline_file: ''ignore''})'
    dependencies: []
    task:
      jobs:
        - name: Bundle install
          commands:
            - 'true'
  - name: Tests
    run:
      when: 'change_in(''/web/'', {default_branch: ''diagram'', pipeline_file: ''ignore''})'
    dependencies:
      - Install Web Dependencies
    task:
      jobs:
        - name: Unit tests
          commands:
            - 'true'
        - name: Integration tests
          commands:
            - 'true'
        - name: Static tests
          commands:
            - 'true'
  - name: Deploy Website
    run:
      when: 'change_in(''/web/'', {default_branch: ''diagram'', pipeline_file: ''ignore''})'
    dependencies:
      - Tests
    task:
      jobs:
        - name: Deploy to prod
          commands:
            - 'true'
